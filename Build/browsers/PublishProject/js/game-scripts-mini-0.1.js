(function(e,t,n){var r=function(t){var n=t.split("."),r=e;for(var i=0;i<n.length;i++)r[n[i]]||(r[n[i]]={}),r=r[n[i]]};r("com.qici.extraUI");var i=qc.ScrollView,s=com.qici.extraUI.ScrollSupport=function(e,t,n,r,s){this.game=e,this.node=t,this._getViewRect=n,this._getContentRect=r,this._setContentPosition=s,this.canHorizontal=!0,this.canVertical=!0,this.movementType=i.MOVEMENT_ELASTIC,this.elasticity=1,this.inertia=!0,this.decelerationRate=.03,this.scrollSensitivity=1,this.propagationScroll=!1,this.onValueChange=new Phaser.Signal,this._preContentPosition=null,this._preContentRect=null,this._preViewRect=null,this._velocity=new qc.Point(0,0),this._isDragging=!1,this.pivotX=0,this.pivotY=0,this.node&&(this.node.onWheel.add(this._doWheel,this),this.node.onDragStart.add(this._doDragStart,this),this.node.onDrag.add(this._doDrag,this),this.node.onDragEnd.add(this._doDragEnd,this))};s.prototype={},s.prototype.constructor=s,t.defineProperties(s.prototype,{horizontalScrollBar:{get:function(){return this._horizontalScrollBar&&this._horizontalScrollBar._destroy&&(this._horizontalScrollBar=null),this._horizontalScrollBar},set:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onValueChange.remove(this._setHorizontalNormalizedPosition,this),this._horizontalScrollBar=e,this._horizontalScrollBar&&this._horizontalScrollBar.onValueChange.add(this._setHorizontalNormalizedPosition,this)}},verticalScrollBar:{get:function(){return this._verticalScrollBar&&this._verticalScrollBar._destroy&&(this._verticalScrollBar=null),this._verticalScrollBar},set:function(e){this._verticalScrollBar&&this._verticalScrollBar.onValueChange.remove(this._setVerticalNormalizedPosition,this),this._verticalScrollBar=e,this._verticalScrollBar&&this._verticalScrollBar.onValueChange.add(this._setVerticalNormalizedPosition,this)}},horizontalNormalizedPosition:{get:function(){return this._updateBounds(),this._contentRect.width<=this._viewRect.width?this._viewRect.x>this._contentRect.x?1:0:(this._viewRect.x-this._contentRect.x)/(this._contentRect.width-this._viewRect.width)},set:function(e){this.setNormalizedPosition(e,0)}},verticalNormalizedPosition:{get:function(){return this._updateBounds(),this._contentRect.height<=this._viewRect.height?this._viewRect.y>this._contentRect.y?1:0:(this._viewRect.y-this._contentRect.y)/(this._contentRect.height-this._viewRect.height)},set:function(e){this.setNormalizedPosition(e,1)}}}),s.prototype.destroy=function(){this.node&&(this.node.onWheel.remove(this._doWheel,this),this.node.onDragStart.remove(this._doDragStart,this),this.node.onDrag.remove(this._doDrag,this),this.node.onDragEnd.remove(this._doDragEnd,this)),this.node=null,this._setContentPosition=null,this._getContentRect=null,this._getViewRect=null,this.horizontalScrollBar=null,this.verticalScrollBar=null},s.prototype.update=function(e){this._updateVelocity(e)},s.prototype.getViewRect=function(){return this._getViewRect?this._getViewRect():new qc.Rectangle(0,0,0,0)},s.prototype.getContentRect=function(){return this._getContentRect?this._getContentRect():new qc.Rectangle(0,0,0,0)},s.prototype.setContentPosition=function(e,t){this._setContentPosition&&this._setContentPosition(e,t)},s.prototype._setHorizontalNormalizedPosition=function(e){this.setNormalizedPosition(e,0)},s.prototype._setVerticalNormalizedPosition=function(e){this.setNormalizedPosition(e,1)},s.prototype._calculateOffset=function(e,t){var n=new qc.Point(0,0);if(this.movementType===i.MOVEMENT_UNRESTRICTED)return n;var r=this.getViewRect(),s=this._contentRect,o=new qc.Point(s.x,s.y),u=new qc.Point(s.x+s.width,s.y+s.height);return this.canHorizontal&&(o.x+=e,u.x+=e,o.x>r.x?n.x=r.x-o.x:u.x<r.x+r.width&&(n.x=r.x+r.width-u.x)),this.canVertical&&(o.y+=t,u.y+=t,o.y>r.y?n.y=r.y-o.y:u.y<r.y+r.height&&(n.y=r.y+r.height-u.y)),n},s.prototype._calcVelocityEffect=function(e,t,n,r){if(this.movementType===i.MOVEMENT_ELASTIC&&t[r]!==0){var s=this["_lastOffset_"+r]||0;Math.abs(s)<Math.abs(t[r])?(this["_lastOffset_"+r]=t[r],this._currSmoothetTime=n):(this["_lastOffset_"+r]=t[r],this._currSmoothetTime+=n);var o=this.elasticity<=0?n:this.elasticity,u=this.game.math.smoothDamp(e[r],e[r]+t[r],this._velocity[r],this.elasticity,Number.MAX_VALUE,n/100);Math.abs(e[r]+t[r]-u[0])<1e-4?(e[r]=e[r]+t[r],this._velocity[r]=0):(e[r]=u[0],this._velocity[r]=u[1])}else if(this.movementType===i.MOVEMENT_CLAMPED&&t[r]!==0)e[r]=e[r]+t[r];else if(this.inertia){var a=this._velocity[r]*Math.pow(Math.abs(this.decelerationRate),n/1e3);Math.abs(a)<1&&(a=0),this._velocity[r]=a,e[r]=e[r]+a*n/1e3}else this._velocity[r]=0},s.prototype._rubberDelta=function(e,t){return(1-1/(Math.abs(e)*.55/t+1))*t*this.game.math.sign(e)},s.prototype._updateVelocity=function(e){var t,n;this._updateBounds();var r=this._calculateOffset(0,0);!this._isDragging&&(r.x!==0||r.y!==0||this._velocity.x!==0||this._velocity.y!==0)&&(t=this.getContentRect(),n=new qc.Point(t.x,t.y),this._calcVelocityEffect(n,r,e,"x"),this._calcVelocityEffect(n,r,e,"y"),(this._velocity.x!==0||this._velocity.y!==0)&&this.movementType===i.MOVEMENT_CLAMPED&&(r=this._calculateOffset(n.x-t.x,n.y-t.y),n.x+=r.x,n.y+=r.y),this.setContentPosition(n.x,n.y));if(this._isDragging&&this.inertia){t=this.getContentRect();var s=t.x-this._preContentPosition.x,o=t.y-this._preContentPosition.y,u=this.game.math.clamp(e/1e3,0,1);this._velocity.x=s/u,this._velocity.y=o/u}if(!this._preViewRect||!qc.Rectangle.equals(this._viewRect,this._preViewRect)||!this._preContentRect||!qc.Rectangle.equals(this._contentRect,this._preContentRect))this._updateScrollBars(r.x,r.y),this.onValueChange.dispatch(new qc.Point(this.horizontalNormalizedPosition,this.verticalNormalizedPosition)),this._updatePrevData()},s.prototype.setNormalizedPosition=function(e,t){this._updateBounds();if(!this._contentRect)return;var n=this.getContentRect(),r=t?"height":"width",i=t?"y":"x",s=this._contentRect[r]-this._viewRect[r],o=this._viewRect[i]-e*s,u=n[i]+o-this._contentRect[i],a=n[i];Math.abs(a-u)>1&&(n[i]=u,this.setContentPosition(n.x,n.y),this._velocity[i]=0,this._updateBounds())},s.prototype._updatePrevData=function(){var e=this.getContentRect();this._preContentPosition=new qc.Point(e.x,e.y),this._preContentRect=this._contentRect,this._preViewRect=this._viewRect},s.prototype._updateScrollBars=function(e,t){var n;this.horizontalScrollBar&&(this._contentRect.width>0?(n=(this._viewRect.width-Math.abs(e))/this._contentRect.width,this.horizontalScrollBar.size=Phaser.Math.clamp(n,0,1)):this.horizontalScrollBar.size=1,this.horizontalScrollBar.value=this.horizontalNormalizedPosition),this.verticalScrollBar&&(this._contentRect.height>0?(n=(this._viewRect.height-Math.abs(t))/this._contentRect.height,this.verticalScrollBar.size=Phaser.Math.clamp(n,0,1)):this.verticalScrollBar.size=1,this.verticalScrollBar.value=this.verticalNormalizedPosition)},s.prototype._updateBounds=function(){var e=this._viewRect=this.getViewRect();this._updateContentBounds();if(!this._getContentRect)return;var t=e.width-this._contentRect.width,n=e.height-this._contentRect.height;t>0&&(this._contentRect.width=e.width,this._contentRect.x-=t*this.pivotX),n>0&&(this._contentRect.height=e.height,this._contentRect.y-=n*this.pivotY)},s.prototype._updateContentBounds=function(){this._contentRect=this.getContentRect()},s.prototype._doWheel=function(e,t){this._updateBounds();var n=new qc.Point(t.source.deltaX,t.source.deltaY);this.canVertical||(n.y=0),this.canHorizontal||(n.x=0);var r=n.x*this.scrollSensitivity,i=n.y*this.scrollSensitivity;this.doScroll(r,i,!1)},s.prototype._doDragStart=function(e,t){if(t.source.eventId!==qc.Mouse.BUTTON_LEFT)return;this._updateBounds();var n=this.getContentRect();this._contentStartPosition=new qc.Point(n.x,n.y),this._pointerStartCursor=this.node.toLocal(new qc.Point(t.source.startX,t.source.startY)),this._isDragging=!0},s.prototype._doDragEnd=function(e,t){if(t.source.eventId!==qc.Mouse.BUTTON_LEFT)return;this._isDragging=!1},s.prototype._doDrag=function(e,t){if(t.source.eventId!==qc.Mouse.BUTTON_LEFT)return;this._updateBounds();var n=this.getContentRect(),r=this.node.toLocal(new qc.Point(t.source.x,t.source.y));if(!this._pointerStartCursor)return;var i=this.canHorizontal?r.x-this._pointerStartCursor.x:0,s=this.canVertical?r.y-this._pointerStartCursor.y:0;this.doScroll(this._contentStartPosition.x+i-n.x,this._contentStartPosition.y+s-n.y,!0)},s.prototype.doScroll=function(e,t,n){var r=this.getContentRect(),s=new qc.Point(r.x,r.y);s.x+=e,s.y+=t;var o=this._calculateOffset(e,t);s.x+=o.x,s.y+=o.y;if(this.movementType===i.MOVEMENT_CLAMPED&&this.propagationScroll){var u=this.parent;while(!(u instanceof i)&&u!==this.game.world)u=u.parent;u instanceof i&&u.doScroll(-o.x,-o.y,n)}else this.movementType===i.MOVEMENT_ELASTIC&&(n?(o.x!==0&&(s.x=s.x-this._rubberDelta(o.x,this._viewRect.width)),o.y!==0&&(s.y=s.y-this._rubberDelta(o.y,this._viewRect.height))):(s.x-=o.x,s.y-=o.y,Math.abs(o.x)>this._viewRect.width&&(s.x+=o.x-this.game.math.sign(o.x)*this._viewRect.width),Math.abs(o.y)>this._viewRect.height&&(s.y+=o.y-this.game.math.sign(o.y)*this._viewRect.height)));this.setContentPosition(s.x,s.y),n||this._updateBounds()};var o=qc.defineBehaviour("com.qici.extraUI.TableViewAdapter",qc.Behaviour,function(){var e=this;e.onDataChange=new qc.Signal},{});t.defineProperties(o.prototype,{}),o.prototype.dispatchDataChange=function(){this.onDataChange.dispatch()},o.prototype.getTableSize=function(){return{x:1,y:Infinity}},o.prototype.findCellWithPos=function(e,t){return{x:Math.floor(e/100),y:Math.floor(t/100)}},o.prototype.getCellRect=function(e,t){return new qc.Rectangle(e*100,t*100,100,100)},o.prototype.revokeCell=function(e,t,n){},o.prototype.createCell=function(e,t,n){};var u=qc.defineBehaviour("com.qici.extraUI.TableView",qc.Behaviour,function(){var e=this;e._cellPool=[],e._usingCell=[],e._showRect=new qc.Rectangle(0,0,0,0),e.scrollSupport=new com.qici.extraUI.ScrollSupport(e.game,e.gameObject,e._getViewRect.bind(e),e._getContentRect.bind(e),e._setContentPosition.bind(e)),e.runInEditor=!0},{content:qc.Serializer.NODE,adapterNode:qc.Serializer.NODE,horizontalScrollBar:qc.Serializer.NODE,verticalScrollBar:qc.Serializer.NODE,cellPrefab:qc.Serializer.PREFAB,overflow:qc.Serializer.BOOLEAN,canHorizontal:qc.Serializer.BOOLEAN,canVertical:qc.Serializer.BOOLEAN,movementType:qc.Serializer.NUMBER,elasticity:qc.Serializer.NUMBER,inertia:qc.Serializer.BOOLEAN,decelerationRate:qc.Serializer.NUMBER,scrollSensitivity:qc.Serializer.NUMBER,propagationScroll:qc.Serializer.BOOLEAN,extraLeft:qc.Serializer.NUMBER,extraRight:qc.Serializer.NUMBER,extraTop:qc.Serializer.NUMBER,extraBottom:qc.Serializer.NUMBER});t.defineProperties(u.prototype,{adapterNode:{get:function(){return this._adapterNode||this.gameObject},set:function(e){if(e===this._adapterNode)return;this._adapterNode=e,this._adapter&&(this._adapter.onDataChange.remove(this._clearTable,this),this._adapter=null),this._needRebuild=!0}},adapter:{get:function(){return this._adapter||(this._adapter=this.adapterNode&&this.adapterNode.getScript("com.qici.extraUI.TableViewAdapter"),this._adapter&&this._adapter.onDataChange.add(this._clearTable,this)),this._adapter}},content:{get:function(){return this._content&&this._content._destroy&&(this.content=null),this._content},set:function(e){var t=this;t._content&&(t._content.onChildrenChanged.remove(t._doChildrenChanged,t),t._content.onLayoutArgumentChanged.remove(t._doLayoutArgumentChanged,t)),t._content=e,t._needRebuild=!0,t._content&&(t._content.onChildrenChanged.add(t._doChildrenChanged,t),t._content.onLayoutArgumentChanged.add(t._doLayoutArgumentChanged,t))}},cellPrefab:{get:function(){return this._cellPrefab},set:function(e){if(e===this._cellPrefab)return;this._cellPrefab=e,this.content&&this.content.removeChildren(),this._cellPool=[],this._needRebuild=!0}},overflow:{get:function(){return this._overflow},set:function(e){if(e===this._overflow)return;this._overflow=e,this._needRebuild=!0}},extraLeft:{get:function(){return this._extraLeft||0},set:function(e){if(e===this._extraLeft)return;this._extraLeft=e,this._needRebuild=!0}},extraRight:{get:function(){return this._extraRight||0},set:function(e){if(e===this._extraRight)return;this._extraRight=e,this._needRebuild=!0}},extraTop:{get:function(){return this._extraTop||0},set:function(e){if(e===this._extraTop)return;this._extraTop=e,this._needRebuild=!0}},extraBottom:{get:function(){return this._extraBottom||0},set:function(e){if(e===this._extraBottom)return;this._extraBottom=e,this._needRebuild=!0}},canHorizontal:{get:function(){return this.scrollSupport?this.scrollSupport.canHorizontal:null},set:function(e){this.scrollSupport&&(this.scrollSupport.canHorizontal=e)}},canVertical:{get:function(){return this.scrollSupport?this.scrollSupport.canVertical:null},set:function(e){this.scrollSupport&&(this.scrollSupport.canVertical=e)}},movementType:{get:function(){return this.scrollSupport?this.scrollSupport.movementType:null},set:function(e){this.scrollSupport&&(this.scrollSupport.movementType=e)}},elasticity:{get:function(){return this.scrollSupport?this.scrollSupport.elasticity:null},set:function(e){this.scrollSupport&&(this.scrollSupport.elasticity=e)}},inertia:{get:function(){return this.scrollSupport?this.scrollSupport.inertia:null},set:function(e){this.scrollSupport&&(this.scrollSupport.inertia=e)}},decelerationRate:{get:function(){return this.scrollSupport?this.scrollSupport.decelerationRate:null},set:function(e){this.scrollSupport&&(this.scrollSupport.decelerationRate=e)}},scrollSensitivity:{get:function(){return this.scrollSupport?this.scrollSupport.scrollSensitivity:null},set:function(e){this.scrollSupport&&(this.scrollSupport.scrollSensitivity=e)}},propagationScroll:{get:function(){return this.scrollSupport?this.scrollSupport.propagationScroll:null},set:function(e){this.scrollSupport&&(this.scrollSupport.propagationScroll=e)}},horizontalScrollBar:{get:function(){return this.scrollSupport?this.scrollSupport.horizontalScrollBar:null},set:function(e){this.scrollSupport&&(this.scrollSupport.horizontalScrollBar=e)}},verticalScrollBar:{get:function(){return this.scrollSupport?this.scrollSupport.verticalScrollBar:null},set:function(e){this.scrollSupport&&(this.scrollSupport.verticalScrollBar=e)}},horizontalNormalizedPosition:{get:function(){return this.scrollSupport?this.scrollSupport.horizontalNormalizedPosition:null},set:function(e){this.scrollSupport&&this.scrollSupport.setNormalizedPosition(e,0)}},verticalNormalizedPosition:{get:function(){return this.scrollSupport?this.scrollSupport.verticalNormalizedPosition:null},set:function(e){this.scrollSupport&&this.scrollSupport.setNormalizedPosition(e,1)}}}),u.prototype.awake=function(){},u.prototype.onDestroy=function(){var e=this;e.content=null,e.cellPrefab=null,e._adapter=null,e.adapterNode=null,e._cellPool=[],e._showCell=[],e._usingCell=[]},u.prototype.update=function(){this.content&&(this.scrollSupport.pivotX=this.content.pivotX,this.scrollSupport.pivotY=this.content.pivotY),this.scrollSupport.update(this.game.time.deltaTime),this._needRebuild&&this._rebuildTable()},u.prototype.relayout=function(){this._rebuildTable()},u.prototype._clearTable=function(){var e=this,t=e.gameObject,n=e.content;n.x=0,n.y=0,e.revokeAllCell()},u.prototype.revokeAllCell=function(){var e=this,t=e.content;t.removeChildren(),Array.prototype.push.apply(e._cellPool,e._usingCell),e._usingCell=[]},u.prototype._revokeCell=function(e){var t=this;t._cellPool.push(e);var n=t._usingCell.indexOf(e);n>=0&&t._usingCell.splice(n,1)},u.prototype._createCell=function(){var e=this;if(!e._cellPrefab)return null;var t=e._cellPool.pop()||e.game.add.clone(e._cellPrefab,e.gameObject);return t&&e._usingCell.push(t),t},u.prototype._getViewRect=function(){return this.gameObject.rect},u.prototype._getContentRect=function(){var e=this,t=e.adapter,n=e.content;if(!n||!t)return new qc.Rectangle(0,0,0,0);var r=t.getTableSize(),i=r.x<Infinity?r.x-1:0,s=r.y<Infinity?r.y-1:0,o=t.getCellRect(i,s);return new qc.Rectangle(n.x,n.y,r.x<Infinity?o.x+o.width:Infinity,r.y<Infinity?o.y+o.height:Infinity)},u.prototype._setContentPosition=function(e,t){var n=this,r=n.content;if(!r)return;r.x=e,r.y=t,n._rebuildTable()},u.prototype._getViewRectInTable=function(){var e=this,t=e.gameObject,n=t.rect,r=e.content;return r?new qc.Rectangle(n.x-e.extraLeft-r.x,n.y-e.extraTop-r.y,n.width+e.extraLeft+e.extraRight,n.height+e.extraTop+e.extraBottom):new qc.Rectangle(0,0,0,0)},u.prototype._setCellRect=function(e,t,n,r,i){var s=this,o=s.content;if(!o||!e)return;e.x=t,e.y=n,e.width=r,e.height=i},u.prototype._rebuildTable=function(){var e=this,t=e.adapter,n=e.content;if(!n)return;if(!t){this._clearTable();return}var r=t.getTableSize();if(r.x<=0||r.y<=0||r.x===Infinity&&r.y===Infinity){this._clearTable();return}var i=e._getViewRectInTable(),s=e._showRect,o=i.x,u=i.x+i.width,a=i.y,f=i.y+i.height,l=t.findCellWithPos(o,a),c=t.findCellWithPos(u,f);if(!e.overflow){var h=t.findCellWithPos(o-1,a-1),p=t.findCellWithPos(u+1,f+1);h.x===l.x&&++l.x,h.y===l.y&&++l.y,p.x===c.x&&--c.x,p.y===c.y&&--c.y}var d=Math.max(l.x,0),v=Math.max(l.y,0),m=Math.min(c.x,r.x-1),g=Math.min(c.y,r.y-1),y=n.children,b=s.width*s.height;b!==y.length&&(n.removeChildren(),s.setTo(0,0,0,0),b=0);var w,E,S,x,T,N=b-1;for(E=s.y+s.height-1,x=s.y;E>=x;--E)for(S=s.x+s.width-1,T=s.x;S>=T;--S,--N){if(S>=d&&S<=m&&E>=v&&E<=g)continue;w=n.removeChildAt(N),t.revokeCell(w,S,E),e._revokeCell(w)}var C=Math.max(s.x,d),k=Math.max(s.y,v),L=Math.min(s.x+s.width-1,m),A=Math.min(s.y+s.height-1,g),O=m-d+1,M=g-v+1;if(O>0&&M>0){N=0;for(E=v;E<=g;++E)for(S=d;S<=m;++S,++N){if(S>=C&&S<=L&&E>=k&&E<=A)continue;w=e._createCell();if(!w)continue;n.addChildAt(w,N);var _=t.getCellRect(S,E);e._setCellRect(w,_.x,_.y,_.width,_.height),t.createCell(w,S,E)}}s.setTo(d,v,O,M)},u.prototype._doChildrenChanged=function(e){this._needRebuild=!0},u.prototype._doLayoutArgumentChanged=function(){this._needRebuild=!0};var a=qc.defineBehaviour("qc.TweenFunction",qc.Tween,function(){var e=this;e.funcName="",e.func=null,e.funcContext=null,e.enable=!1},{funcName:qc.Serializer.STRING});a.__menu="Plugins/TweenFunction",t.defineProperties(a.prototype,{funcName:{get:function(){return this._funcName},set:function(e){if(e===this._funcName)return;this._funcName=e,this.onEnable()}}}),a.prototype.onEnable=function(){if(this._funcName.length<=0)return;this.func=this.gameObject[this._funcName];var t=[];this.func&&(t.push(this.gameObject.class),this.func=this.func.bind(this.gameObject));var n=this;this.gameObject.scripts.forEach(function(e){var r=e[n._funcName];r&&(t.push(e.class),n.func=r.bind(e))}),!n.func&&this.enable&&this.game.log.important("TweenFunction({0}) not find!",this._funcName);if(t.length<=1)return;n.game.log.error("Error: Exist multi functions with same name: {0}",t);if(n.game.device.editor===!0){var r=e.parent&&e.parent.G;if(r){var i=r._("TweenFunction func error")+t;r.notification.error(i)}}},a.prototype.onUpdate=function(e,t){if(typeof this.func!="function")return;if(this.duration==0&&!t)return;this.func(e,this.duration)},a.begin=function(e,t,n){var r=qc.Tween.begin("qc.TweenFunction",e,t);return r.funcName=n,r};var f=qc.Koala={ui:{},logic:{},game:null,GAMEWIDTH:640,onLogicReady:new qc.Signal,onPillarReady:new qc.Signal,onStart:new qc.Signal,onSwingTake:new qc.Signal,onGameOver:new qc.Signal,onScoreChange:new qc.Signal,onPause:new qc.Signal,onContinue:new qc.Signal,onAdjustCamera:new qc.Signal,onTweenCamera:new qc.Signal,showRanking:new qc.Signal,onRankingClose:new qc.Signal,onLogin:new qc.Signal,onLogining:new qc.Signal,onLoginFail:new qc.Signal,showFollowMsg:new qc.Signal,showShareMsg:new qc.Signal};f.initLogic=function(e,t){this.game=t,t.time.frameRate=60,this.logic.config=new qc.Koala.logic.Config(e),this.logic.me=new qc.Koala.logic.Me,this.logic.pillar=new qc.Koala.logic.Pillar(e),this.logic.wind=new qc.Koala.logic.Wind(e),this.logic.score=new qc.Koala.logic.Score(e),this.logic.share=new qc.Koala.logic.Share(e),this.logic.percent=new qc.Koala.logic.Percent(e),this.onLogicReady.dispatch()},f.resetLogic=function(){this.logic.me.reset()},f.Math={},f.Math.equal=function(e,t){var n=Math.abs(t-e);return n<=1e-10},f.Math.random=function(e,t){e=e==null?0:e,t=t==null?1:t;var n=t-e+1;return Math.floor(Math.random()*n+e)};var l=qc.defineBehaviour("qc.Koala.ui.FollowMsg",qc.Behaviour,function(){},{label:qc.Serializer.NODE,followBtn:qc.Serializer.NODE,closeBtn:qc.Serializer.NODE});l.prototype.awake=function(){this.addListener(this.followBtn.onClick,this._follow,this),this.addListener(this.closeBtn.onClick,this.hide,this),this.addListener(qc.Koala.showFollowMsg,this.show,this)},l.prototype.initLabel=function(){qc.qcWeChat.isWeChat()&&qc.Koala.logic.me.userInfo&&!qc.Koala.logic.me.userInfo.subscribe?this.label.text="亲，需要[#76ffef]关注公众号[-]后才能查看排行榜哦！":this.label.text="亲，你要[#76ffef]关注公众号[-]并通过[#76ffef]微信登录[-]，才能查看排行榜哦！"},l.prototype._follow=function(){document.location.href=qc.Koala.logic.config.followHref},l.prototype.hide=function(){this.gameObject.visible=!1},l.prototype.show=function(){this.gameObject.visible=!0,this.initLabel()};var c=qc.Koala.logic.Config=function(e){e||(e=qc.Koala.game.assets.load("config"));var t=e.findSheet("config");t&&t.rows.forEach(function(e){var t=e.value;e.type==="number"&&(t*=1),this[e.key]=t},this)},h=qc.Koala.logic.Me=function(){this.level=1,this._score=0,this._best=0,this.isDie=!1,this.paused=!1,this.token="",this.rid="",this.userInfo=null,this.channel=""};h.prototype={},h.prototype.constructor=h,t.defineProperties(h.prototype,{score:{get:function(){return this._score},set:function(e){if(this._score===e)return;this._score=e,this.best=e,qc.Koala.onScoreChange.dispatch(e)}},best:{get:function(){return this._best},set:function(e){if(this._best>=e)return;this._best=e;var t="best_"+this.rid;qc.Koala.game.storage.set(t,e)}}}),h.prototype.reset=function(){this.level=1,this.score=0,this.isDie=!1,this.paused=!1},h.prototype.addScore=function(e){if(typeof e!="number"||e<=0)return;this.score=this._score+e},h.prototype.adjustBest=function(){if(!this.userInfo)return;var e=this.userInfo.scorers;this.readFromStorage(),e>this._best&&(this.best=e)},h.prototype.readFromStorage=function(){var e="best_"+this.rid,t=qc.Koala.game.storage.get(e);t&&(this.best=t)},h.prototype.saveToStorage=function(){qc.Koala.game.storage.save()};var p=function(e){this.id=e.id*1,this.min=e.min*1,this.max=e.max*1||Infinity,this.base=e.base*1,this.space=e.space*1,this.increment=e.increment*1},d=qc.Koala.logic.Percent=function(e){this.infoList=[],e||(e=qc.Koala.game.assets.load("config"));var t=e.findSheet("percent");t&&t.rows.forEach(function(e){this.infoList.push(new p(e))},this)};d.prototype={},d.prototype.constructor=d,d.prototype.getPercent=function(e){var t=null;for(var n=0,r=this.infoList.length;n<r;n++){t=this.infoList[n];if(e>t.min&&e<=t.max)break}if(t.space===0)return t.base;var i=t.base;return i+=Math.floor((e-t.min)/t.space)*t.increment,i};var v=function(e){this.id=e.id*1,this.minLv=e.minLv*1,this.maxLv=e.maxLv*1||Infinity,this.thickness=e.thickness*1,this.top=e.top*1,this.headIcon=e.headIcon,this.scoreRect=e.scoreRect*1||Infinity},m=qc.Koala.logic.Pillar=function(e){this.infoList=[],this.infoMap={},e||(e=qc.Koala.game.assets.load("config"));var t=e.findSheet("pillar");t&&t.rows.forEach(function(e){this.infoList.push(new v(e))},this)};m.prototype.getInfo=function(e){var t=this.infoMap[e];if(!t){var n=this._find(e);t={thickness:qc.Koala.logic.config.pillarWidth,top:qc.Koala.logic.config.pillarTopMin,headIcon:qc.Koala.logic.config.pillarHeadIcon,scoreRect:Infinity},n&&(t.thickness*=n.thickness,t.top=n.top*qc.Koala.logic.config.pillarTopMax,t.headIcon=n.headIcon,t.scoreRect=n.scoreRect),this.infoMap[e]=t}return t},m.prototype._find=function(e){for(var t=0,n=this.infoList.length;t<n;t++){var r=this.infoList[t];if(e<r.minLv)continue;if(e>=r.minLv&&e<=r.maxLv)return r}return null};var g=function(e){this.id=e.id*1,this.min=e.min*1,this.max=e.max*1,this.value=e.value*1,this.scoreImg=e.scoreImg,this.labelImg=e.labelImg,this.effectName=e.effectName},y=qc.Koala.logic.Score=function(e){this.infoList=[],this.defaultInfo=null,e||(e=qc.Koala.game.assets.load("config"));var t=e.findSheet("score");t&&t.rows.forEach(function(e){this.infoList.push(new g(e))},this)};y.prototype.getScore=function(e,t){console.log("scoreRect:",t);if(e>t)return this.defaultInfo||(this.defaultInfo={value:qc.Koala.logic.config.minScore,labelImg:qc.Koala.logic.config.labelImg,scoreImg:qc.Koala.logic.config.scoreImg}),this.defaultInfo;var n=null;for(var r=0,i=this.infoList.length;r<i;r++){n=this.infoList[r];if(e>n.min&&e<=n.max)break}return n};var b=function(e){this.id=e.id*1,this.min=e.min*1,this.max=e.max*1,this.max=this.max==null?Infinity:this.max,this.content=e.content},w=qc.Koala.logic.Share=function(e){this.shareMap={},e||(e=qc.Island.game.assets.find("config"));var t=e.findSheet("share");for(var n in t.rows){var r=t.rows[n];this.shareMap[r.id]=new b(r)}};w.prototype={},w.prototype.constructor=w,w.prototype.getContent=function(e){for(var t in this.shareMap){var n=this.shareMap[t];if(e>=n.min&&e<=n.max)return n.content.replace("{0}",e)}};var E=function(e){this.id=e.id*1,this.minLv=e.minLv*1,this.maxLv=e.maxLv*1||Infinity,this.minWind=e.minWind*1,this.maxWind=e.maxWind*1},S=qc.Koala.logic.Wind=function(e){this.infoList=[],this.infoMap={},e||(e=qc.Koala.game.assets.load("config"));var t=e.findSheet("wind");t&&t.rows.forEach(function(e){this.infoList.push(new E(e))},this)};S.prototype.getWind=function(e){var t=this.infoMap[e],n=qc.Koala.Math.random(0,1);n=n===0?-1:n;if(!t)for(var r=0,i=this.infoList.length;r<i;r++){t=this.infoList[r];if(e>=t.minLv&&e<=t.maxLv){this.infoMap[e]=t;break}}return{direction:n,value:qc.Koala.Math.random(t.minWind,t.maxWind)}};var x=qc.defineBehaviour("qc.QcWeChat",qc.Behaviour,function(){var t=this;qc.qcWeChat=this,t.shareAppId="",t.gameName="",t.wxAppId="",t.webAppId="",t.domain="",t.gameDomain="",t.extendParams="",t.redirectCurrentUrl=!0,t.debug=!1,t.wx=new qc.QCWX,e.QcWx=t.wx,t.onInitWx=new qc.Signal,t.onStartLogin=new qc.Signal,t.onLogin=new qc.Signal,t.sessionExpired=new qc.Signal,t.onShare=new qc.Signal,t.user=null,t.status="",t.shareLink="",t._shareBody=null,t.shareSignSuccess=!1,t.shareDir=""},{gameName:qc.Serializer.STRING,shareAppId:qc.Serializer.STRING,wxAppId:qc.Serializer.STRING,webAppId:qc.Serializer.STRING,domain:qc.Serializer.STRING,gameDomain:qc.Serializer.STRING,shareDir:qc.Serializer.STRING,redirectCurrentUrl:qc.Serializer.BOOLEAN,debug:qc.Serializer.BOOLEAN});x.prototype.awake=function(){var t=this;if(!t.domain)return;var n=t.domain+"index.php?cmd=sign&appid="+t.shareAppId+"&url="+encodeURIComponent(e.location.href);t.game.log.trace("开始请求微信分享的签名信息：{0}",n),qc.AssetUtil.get(n,function(e){t.game.log.trace("获取签名成功："+e),t.parseSign(e)},function(){console.error("获取签名信息失败")}),t.loadWXLib(),t._code=this.getParam("code"),t._state=this.getParam("state"),t._code&&(t.isWeChat()||this.game.device.desktop)&&(t.status="loggingIn",t.game.timer.add(1,function(){t.requestToken(t._code)}))},x.prototype.onDestroy=function(){this.timer&&this.game.timer.remove(this.timer)},x.prototype.login=function(){if(!this.game.device.desktop){this.loginInWX();return}this.loginInWeb()},x.prototype._gotoAuth=function(){var t="",n=e.location.origin+e.location.pathname;this.redirectCurrentUrl?t="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+this.wxAppId+"&redirect_uri="+encodeURIComponent(n)+"&response_type=code&scope=snsapi_userinfo&state=weixin#wechat_redirect":t="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+this.wxAppId+"&redirect_uri="+encodeURIComponent(this.domain+"code.php")+"&response_type=code&scope=snsapi_userinfo"+"&state="+encodeURIComponent(n)+"#wechat_redirect",e.location.href=t},x.prototype.loginInWX=function(){if(this.isWeChat()){this.requestToken(this._code);return}this._gotoAuth()},x.prototype.loginInWeb=function(){var t="",n=e.location.origin+e.location.pathname;this.redirectCurrentUrl?t="https://open.weixin.qq.com/connect/qrconnect?appid="+this.webAppId+"&redirect_uri="+encodeURIComponent(n)+"&response_type=code&scope=snsapi_login&state=pc#wechat_redirect":t="https://open.weixin.qq.com/connect/qrconnect?appid="+this.webAppId+"&redirect_uri="+encodeURIComponent(this.domain+"code.php")+"&response_type=code&scope=snsapi_login"+"&state="+encodeURIComponent(n)+"#wechat_redirect",e.location.href=t},x.prototype.parseSign=function(e){var t=this,n=JSON.parse(e);t.timeStamp=n.timestamp,t.nonceStr=n.nonceStr,t.signature=n.signature,t.shareLink=n.shareLink;if(!t.jweixin){t.game.timer.add(500,function(){t.parseSign(e)});return}t.game.log.trace("开始初始化微信接口"),t.wx.debug=t.debug,t.wx.init({timeStamp:t.timeStamp,nonceStr:t.nonceStr,signature:t.signature,appId:t.shareAppId},function(){t.game.log.trace("初始化微信接口完成。"),t.shareSignSuccess=!0,t.wx.share(t.onShare),t.onInitWx.dispatch()})},x.prototype.loadWXLib=function(){var e=this,t="http://res.wx.qq.com/open/js/jweixin-1.0.0.js",n=document.createElement("script");n.onerror=function(){console.error("加载jweixin库失败")},n.onload=function(){e.game.log.trace("微信接口下载完成"),e.jweixin=!0},n.setAttribute("src",t),n.setAttribute("type","text/javascript"),document.getElementsByTagName("head")[0].appendChild(n)},x.prototype.isWeChat=function(){var t=e.navigator.userAgent.toLowerCase();return t.match(/MicroMessenger/i)=="micromessenger"},x.prototype.getParam=function(e){var t=new RegExp("(\\?|#|&)"+e+"=([^&#]*)(&|#|$)"),n=location.href.match(t);return decodeURIComponent(n?n[2]:"")},x.prototype.requestToken=function(e){var t=this,n=t.gameDomain+"login03.php?code="+e+"&gameName="+t.gameName;this.game.device.desktop&&(n+="&web=1"),t.onStartLogin.dispatch(),qc.AssetUtil.get(n,function(e){var n=JSON.parse(e);if(n.error){if(n.errorCode&&n.errorCode==301){if(t.game.device.desktop){t.loginInWeb();return}t._gotoAuth();return}t.game.log.error("换取token失败，重新请求登录"),t.onLogin.dispatch("fail");return}t.game.log.trace("登录成功：{0}",e),t.status="loggedIn",t.user=n,t.onLogin.dispatch("success"),t.timer=t.game.timer.loop(3e5,t.refreshToken,t)},function(e){t.onLogin.dispatch("fail")})},x.prototype.refreshToken=function(){var e=this,t=e.gameDomain+"refresh.php";this.game.device.desktop&&(t+="?web=1"),qc.AssetUtil.get(t,function(t){var n=JSON.parse(t);if(n.error){e.status="expired",e.game.timer.remove(e.timer),delete e.timer,e.sessionExpired.dispatch();return}e.game.log.trace("刷新Access Token成功。")})};var T=qc.QCWX=function(){var e=this;e.title="",e.imgUrl="",e.desc="",e.url="",e.sign=null,e.ready=!1,e.debug=!1};T.prototype={},T.prototype.constructor=T,T.prototype.init=function(t,n){var r=this;r.sign=t;if(!e.wx)return;wx.config({debug:r.debug,appId:t.appId,timestamp:t.timeStamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["onMenuShareTimeline","onMenuShareQQ","onMenuShareQZone","onMenuShareAppMessage","onMenuShareWeibo","startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","translateVoice","getNetworkType","openLocation","getLocation","closeWindow","scanQRCode"]}),wx.ready(function(){r.ready=!0,n&&n()})},T.prototype.share=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}var n={title:t.title,desc:"",trigger:function(){if(!e)return;e.dispatch(n),n.link=qc.qcWeChat.shareLink+qc.qcWeChat.shareDir}};wx.onMenuShareTimeline(n),wx.onMenuShareAppMessage(n),wx.onMenuShareQQ(n),wx.onMenuShareWeibo(n),wx.onMenuShareQZone(n)},T.prototype.chooseImage=function(e,t,n,r){var i=this;if(!i.ready){console.error("尚未初始化完成");return}t||(t=["original","compressed"]),n||(n=["album","camera"]),wx.chooseImage({count:e,sizeType:t,sourceType:n,success:function(e){r&&r(e.localIds)}})},T.prototype.previewImage=function(e,t){var n=this;if(!n.ready){console.error("尚未初始化完成");return}e=e||"",t=t||[],wx.previewImage({current:e,urls:t})},T.prototype.uploadImage=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.uploadImage({localId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.serverId)}})},T.prototype.downloadImage=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.downloadImage({serverId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.localId)}})},T.prototype.startRecord=function(){var e=this;if(!e.ready){console.error("尚未初始化完成");return}wx.startRecord()},T.prototype.stopRecord=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.stopRecord({success:function(t){e&&e(t.localId)}})},T.prototype.onVoiceRecordEnd=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.onVoiceRecordEnd({complete:function(t){e&&e(t.localId)}})},T.prototype.playVoice=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.playVoice({localId:e})},T.prototype.pauseVoice=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.pauseVoice({localId:e})},T.prototype.stopVoice=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.stopVoice({localId:e})},T.prototype.onVoicePlayEnd=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.onVoicePlayEnd({success:function(t){e&&e(t.localId)}})},T.prototype.uploadVoice=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.uploadVoice({localId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.serverId)}})},T.prototype.downloadVoice=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.downloadVoice({serverId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.localId)}})},T.prototype.translateVoice=function(e,t,n){var r=this;if(!r.ready){console.error("尚未初始化完成");return}wx.translateVoice({localId:e,isShowProgressTips:t?1:0,success:function(e){n&&n(e.translateResult)}})},T.prototype.getNetworkType=function(e){var t=this;if(!t.ready){console.error("尚未初始化完成");return}wx.getNetworkType({success:function(t){e&&e(t.networkType)}})},T.prototype.openLocation=function(e,t,n,r,i,s){var o=this;if(!o.ready){console.error("尚未初始化完成");return}e=e||0,t=t||0,i=i||1,n=n||"",r=r||"",s=s||"",wx.openLocation({latitude:e,longitude:t,name:n,address:r,scale:i,infoUrl:s})},T.prototype.getLocation=function(e,t){var n=this;if(!n.ready){console.error("尚未初始化完成");return}e=e||"wgs84",wx.getLocation({type:e,success:t})},T.prototype.scanQRCode=function(e,t){var n=this;if(!n.ready){console.error("尚未初始化完成");return}wx.scanQRCode({needResult:e,scanType:["qrCode","barCode"],success:function(e){t&&t(e.resultStr)}})},T.prototype.closeWindow=function(){var e=this;if(!e.ready){console.error("尚未初始化完成");return}wx.closeWindow()},T.prototype.chooseWXPay=function(){};var N=qc.defineBehaviour("qc.Koala.ui.Background",qc.Behaviour,function(){this.tweenDistance=0,this.mountainDistance=635,this.treeDistance=340,this.mountains=[],this.trees=[],this.treeIcons=["tree_1.bin","tree_2.bin","tree_3.bin"]},{clouds:qc.Serializer.NODES,mountainRect:qc.Serializer.NODE,mountainPrefab:qc.Serializer.PREFAB,treeRect:qc.Serializer.NODE,treePrefab:qc.Serializer.PREFAB});N.prototype.awake=function(){this.addListener(qc.Koala.onAdjustCamera,this._adjust,this),this.addListener(qc.Koala.onTweenCamera,this._tween,this),this.addListener(this.game.world.onSizeChange,function(){this.initMountain(),this.initTree()},this),this.game.timer.add(1e3,this.init,this)},N.prototype.init=function(){this.clouds.forEach(function(e){var t=e.getScript("qc.TweenPosition");t.from.setTo(e.parent.width,t.from.y),t.resetToBeginning(),t.play(),e.visible=!0},this),this.initMountain(),this.initTree()},N.prototype.initMountain=function(){var e=Math.ceil(this.gameObject.width/this.mountainDistance)+1,t=e-this.mountains.length;if(t<=0)return;this._createMountain(t)},N.prototype._createMountain=function(e){while(e--){var t=this.game.add.clone(this.mountainPrefab,this.mountainRect);t.x=this.mountainDistance*this.mountains.length,this.mountains.push(t)}},N.prototype.initTree=function(){var e=Math.ceil(this.gameObject.width/this.treeDistance)+1,t=e-this.trees.length;if(t<=0)return;this._createTree(t)},N.prototype._createTree=function(e){while(e--){var t=this.game.add.clone(this.treePrefab,this.treeRect);t.x=this.treeDistance*this.trees.length,this.trees.push(t);var n=this.treeIcons[qc.Koala.Math.random(0,this.treeIcons.length-1)];this.game.assets.load("treeIcon_"+this.trees.length,"Assets/texture/"+n,function(e){this.texture=e}.bind(t)),t.height+=qc.Koala.Math.random(-10,40)}},N.prototype._adjust=function(e){var t=e.x,n=e.y,r=this.gameObject.width,i=t*qc.Koala.logic.config.mountainCoef,s=n*qc.Koala.logic.config.mountainCoef,o=this.mountains.length;this.mountains.forEach(function(e,t){e.x-=i,e.x<=-this.mountainDistance&&(e.x+=this.mountainDistance*o)},this);var u=t*qc.Koala.logic.config.treeCoef,a=n*qc.Koala.logic.config.treeCoef,f=this.trees.length;this.trees.forEach(function(e,t){e.x-=u,e.x<=-this.treeDistance&&(e.x+=this.treeDistance*f)},this)},N.prototype._tween=function(e){this.tweenDistance=e.x,this.mountains.forEach(function(e){e._beginX_=e.x},this),this.trees.forEach(function(e){e._beginX_=e.x},this);var t=this.gameObject.getScript("qc.TweenFunction");t.resetToBeginning(),t.play()},N.prototype.tweenBg=function(e){var t=this.tweenDistance*e,n=t*qc.Koala.logic.config.mountainCoef,r=this.mountains.length;this.mountains.forEach(function(e,t){e.x=e._beginX_+n,e.x<=-this.mountainDistance&&(e.x+=this.mountainDistance*r)},this);var i=t*qc.Koala.logic.config.treeCoef,s=this.trees.length;this.trees.forEach(function(e,t){e.x=e._beginX_+i,e.x<=-this.treeDistance&&(e.x+=this.treeDistance*s)},this)};var C=qc.defineBehaviour("qc.Interactive",qc.Behaviour,function(){qc.interactive=this},{gameName:qc.Serializer.STRING,serverUrl:qc.Serializer.STRING});C.updateScorers=function(e,t,n,r,i){var s=qc.interactive.serverUrl+"updateScorers03.php";s+="?rid="+e,s+="&token="+t,s+="&scorers="+n,s+="&gameName="+qc.interactive.gameName,qc.AssetUtil.get(s,r,i)},C.getRank=function(e,t,n,r,i){var s=qc.interactive.serverUrl+"getRank03.php";s+="?rid="+e,s+="&token="+t,s+="&channel="+n,s+="&gameName="+qc.interactive.gameName,qc.AssetUtil.get(s,r,i)};var k=qc.defineBehaviour("qc.Koala.ui.GameOver",qc.Behaviour,function(){},{restartBtn:qc.Serializer.NODE,shareBtn:qc.Serializer.NODE,moreBtn:qc.Serializer.NODE,rankBtn:qc.Serializer.NODE,goalSign:qc.Serializer.NODE,scoreLabel:qc.Serializer.NODE,bestLabel:qc.Serializer.NODE,percentLabel:qc.Serializer.NODE});k.prototype.awake=function(){this.addListener(qc.Koala.onGameOver,this.show,this),this.addListener(this.restartBtn.onClick,this.onRestartBtnClick,this),this.addListener(this.shareBtn.onClick,function(){qc.Koala.showShareMsg.dispatch()},this),this.addListener(this.moreBtn.onClick,function(){document.location.href=qc.Koala.logic.config.followHref},this),this.addListener(this.rankBtn.onClick,this.onRankBtnClick,this)},k.prototype.initUI=function(){qc.Koala.logic.me.score===qc.Koala.logic.me.best?(this.goalSign.visible=!0,qc.Interactive.updateScorers(qc.Koala.logic.me.rid,qc.Koala.logic.me.token,qc.Koala.logic.me.best,function(e){console.log("更新分数成功")})):this.goalSign.visible=!1;var e=qc.Koala.logic.me.score;this.scoreLabel.text=e+"",this.bestLabel.text="最高分："+qc.Koala.logic.me.best;var t=qc.Koala.logic.percent.getPercent(e);this.percentLabel.text="你击败了全球"+t+"%的玩家"},k.prototype.onRestartBtnClick=function(){qc.Koala.onStart.dispatch(!0),this.hide()},k.prototype.onRankBtnClick=function(){qc.Koala.logic.me.userInfo&&qc.Koala.logic.me.userInfo.subscribe?(qc.Koala.onRankingClose.addOnce(this.show,this),qc.Koala.showRanking.dispatch(),this.hide()):qc.Koala.showFollowMsg.dispatch()},k.prototype.show=function(){this.initUI(),this.gameObject.visible=!0},k.prototype.hide=function(){this.gameObject.visible=!1};var f=qc.defineBehaviour("qc.Koala.ui.Koala",qc.Behaviour,function(){this.swingScript=null,this.currAnimation="stand"},{camera:qc.Serializer.NODE,effect:qc.Serializer.NODE,labelImg:qc.Serializer.NODE,scoreImg:qc.Serializer.NODE,dieImg:qc.Serializer.NODE,brakeImg:qc.Serializer.NODE});f.prototype.awake=function(){this.addListener(qc.Koala.onPause,this._pause,this),this.addListener(qc.Koala.onContinue,this._continue,this)},f.prototype._pause=function(){this.swingScript.stop(),this.gameObject.stop(),this.labelImg.getScript("qc.TweenAlpha").onFinished.removeAll(this);var e=this.gameObject.getScript("qc.TweenPosition");e.onFinished.remove(this.take,this),qc.Tween.stopGroup(this.gameObject,3)},f.prototype._continue=function(){this.currAnimation!=="die"&&this[this.currAnimation]()},f.prototype.init=function(e){qc.Tween.stopGroup(this.gameObject,1),this.swingScript=e.swing,this.gameObject.parent=e.gameObject,this.gameObject.anchoredX=-(e.gameObject.width+this.gameObject.width)*.5,this.gameObject.anchoredY=-e.gameObject.height,this.gameObject.rotation=0,this.updateTween(e),this.stand()},f.prototype.stand=function(){this.currAnimation="stand",this.gameObject.playAnimation("stand")},f.prototype.walk=function(){this.brakeImg.visible=!1,this.labelImg.getScript("qc.TweenAlpha").onFinished.removeAll(this),this.currAnimation="walk",this.gameObject.playAnimation("walk");var e=this.gameObject.getScript("qc.TweenPosition");e.onFinished.addOnce(this.take,this),e.resetToBeginning(),e.play()},f.prototype.take=function(){this.gameObject.onFinished.addOnce(function(){this.gameObject.parent=this.swingScript.gameObject,this.gameObject.anchoredX=0,this.gameObject.anchoredY=0,this.gameObject.rotation=0,this.swing(),qc.Koala.onSwingTake.dispatch()},this),this.currAnimation="take",this.gameObject.playAnimation("take")},f.prototype.swing=function(){if(qc.Koala.logic.me.paused)return;this.swingScript.play(!0),this.currAnimation="swing",this.gameObject.playAnimation("swing")},f.prototype.away=function(){this.gameObject.switchParent(this.camera),this.gameObject.rotation=0,this.currAnimation="away",this.gameObject.playAnimation("away")},f.prototype.fall=function(e){this.swingScript=e.swing,this.gameObject.y=e.gameObject.y+e.gameObject.parent.y,this.gameObject.switchParent(e.gameObject),this.brakeImg.parent=this.gameObject.parent,this.brakeImg.x=this.gameObject.x,this.brakeImg.y=this.gameObject.y,this.brakeImg.visible=!0,this.currAnimation="fall",this.gameObject.playAnimation("fall"),this.updateTween(e);var t=Math.abs(this.gameObject.anchoredX);scoreInfo=qc.Koala.logic.score.getScore(t,e.scoreRect),qc.Koala.logic.me.addScore(scoreInfo.value),this.playEffect(scoreInfo.effectName),this.playLabel(scoreInfo),qc.Tween.resetGroupToBeginning(this.labelImg,1),qc.Tween.playGroup(this.labelImg,1),this.currAnimation="walk"},f.prototype.playLabel=function(e){this.scoreImg.frame=e.scoreImg,this.scoreImg.resetNativeSize(),this.labelImg.frame=e.labelImg,this.labelImg.resetNativeSize(),this.labelImg.getScript("qc.TweenAlpha").onFinished.addOnce(this.walk,this)},f.prototype.playEffect=function(e){if(!e)return;this.effect.parent=this.gameObject.parent,this.effect.x=this.gameObject.x,this.effect.y=this.gameObject.y,this.effect.playAnimation(e)},f.prototype.die=function(e,t){var n=this.gameObject.getScripts("qc.TweenProperty");n.forEach(function(e){e.setCurrToStartValue(),e.property==="anchoredY"?(e.from=this.gameObject.anchoredY,e.to=this.gameObject.height-this.gameObject.parent.y):e.property==="anchoredX"&&(e.from=this.gameObject.anchoredX,e.to=e.from-100)},this),this.dieImg.parent=this.gameObject.parent,this.gameObject.parent.setChildIndex(this.dieImg,this.gameObject.parent.children.length-1),this.dieImg.x=this.gameObject.x,this.dieImg.y=this.gameObject.y;var r=this.dieImg.getScript("qc.TweenAlpha");r.onFinished.addOnce(function(){this.dieImg.visible=!1},this),r.resetToBeginning(),r.play(),this.dieImg.visible=!0,e&&n[0].onFinished.addOnce(e,t),qc.Tween.resetGroupToBeginning(this.gameObject,1),qc.Tween.playGroup(this.gameObject,1),this.currAnimation="die",this.gameObject.playAnimation("die")},f.prototype.reset=function(e){this.init(e)},f.prototype.updateTween=function(e){var t=this.gameObject.getScript("qc.TweenPosition");t.setCurrToStartValue(),t.to=new qc.Point(e.gameObject.width-20,0);if(t.from.x>=t.to.x)t.to=t.from,t.duration=0;else{var n=t.to.x-t.from.x;t.duration=n*.005}};var L=qc.defineBehaviour("qc.Koala.ui.Main",qc.Behaviour,function(){this.windValue=0,this.dropTimer=null,this._step=null,this.swing=null},{pillarPool:qc.Serializer.NODE,koala:qc.Serializer.NODE,pauseBtn:qc.Serializer.NODE,wind:qc.Serializer.NODE,windDirection:qc.Serializer.NODE,score:qc.Serializer.NODE});L.prototype.awake=function(){var e=this,n=this.pillarPool.parent;this.addListener(qc.Koala.onPillarReady,this._onPillarReady,this),this.addListener(qc.Koala.onStart,this.restart,this),this.addListener(qc.Koala.onScoreChange,this.updateScore,this),this.addListener(this.pauseBtn.onClick,this._pause,this),this.addListener(qc.Koala.onContinue,function(){this.pauseBtn.interactive=!0},this),this.gameObject.interactive=!1,this.addListener(qc.Koala.onSwingTake,function(){this.gameObject.interactive=!0},this),this.score._tempText=0,t.defineProperties(this.score,{tempText:{get:function(){return this._tempText},set:function(e){if(this._tempText===e)return;this._tempText=e,this.text=Math.floor(e)+""}}})},L.prototype._onPillarReady=function(e){this.startStep=e[0],this.swing=this.startStep.swing;var t=this.koala.getScript("qc.Koala.ui.Koala");t.init(this.startStep)},L.prototype._pause=function(){if(qc.Koala.logic.me.isDie)return;qc.Koala.logic.me.paused=!0,qc.Koala.onPause.dispatch()},L.prototype.restart=function(){qc.Koala.resetLogic(),this.dropTimer&&(this.game.timer.remove(this.dropTimer),this.dropTimer=null);var e=this.pillarPool.parent,t=e.getScript("qc.TweenPosition");t.onFinished.addOnce(this.start,this),this.resetCamera(),this.show()},L.prototype.start=function(e){if(e===!0){this.restart();return}this.pauseBtn.interactive=!0,this.initWind();var t=this.pillarPool.getScript("qc.Koala.ui.PillarPool");t.reset();var n=this.koala.getScript("qc.Koala.ui.Koala");n.walk()},L.prototype.updateScore=function(e){var t=this.score.getScript("qc.TweenProperty");t.setCurrToStartValue(),t.to=e,qc.Tween.resetGroupToBeginning(this.score,1),qc.Tween.playGroup(this.score,1)},L.prototype.initWind=function(){var e=qc.Koala.logic.wind.getWind(qc.Koala.logic.me.level);this.windValue=e.value*e.direction,this.wind.text=e.value+"",this.wind.parent.visible=e.value!==0,this.windDirection.rotation=Math.PI*(e.direction-1)*.5},L.prototype.onClick=function(){this.gameObject.interactive=!1,qc.Koala.logic.me.level++;var e=this.swing.gameObject.rotation,t=Math.cos(e),n=Math.sin(e),r=this.swing.gameObject.height,i=r*(t-Math.cos(this.swing.maxRotation)),s=this.swing.direction,o=Math.sqrt(2*qc.Koala.logic.config.g*i)*s,u=o*t+this.windValue,a=o*n,f=this.koala.getScript("qc.Koala.ui.Koala");f.away();var l=this.pillarPool.getScript("qc.Koala.ui.PillarPool");this._step=l.getStep(),this.drop(u,a)},L.prototype.drop=function(e,t){this.dropTimer=this.game.timer.loop(0,function(){if(qc.Koala.logic.me.paused)return;var n=this.game.time.deltaTime*.001;t+=qc.Koala.logic.config.g*n,this._onDrop(e,t,n)},this)},L.prototype._onDrop=function(e,t,n){var r=this.koala.y,i=e*n,s=t*n;this.koala.x+=i,this.koala.y+=s,this.adjustCamera(i,s);var o=this._checkCollide(r);o!==0&&(this.game.timer.remove(this.dropTimer),this.dropTimer=null,o===1&&this._onStep(),o<0&&this.gameOver(o))},L.prototype._onStep=function(){var e=this.koala.getScript("qc.Koala.ui.Koala");e.fall(this._step),this.adjustPillar();var t=this.pillarPool.getScript("qc.Koala.ui.PillarPool");t.next(),this.swing.reset(),this.startStep=this._step,this.swing=this._step.swing,this.initWind()},L.prototype._checkCollide=function(e){var t=this.koala.x,n=this.koala.y,r=this._step.gameObject;return t>r.x&&t<r.x+r.width&&e<=r.y+r.parent.y&&n>=r.y+r.parent.y?1:n>this.gameObject.height+this.koala.height-this.pillarPool.parent.y?-1:t>r.x&&t<r.x+r.width&&e>r.y+r.parent.y?-2:0},L.prototype.adjustKoala=function(){var e=this._step.gameObject;this.koala.y>e.y&&this.koala.y<e.y+this.koala.height&&(this.koala.y=e.y)},L.prototype.adjustPillar=function(){var e=this.pillarPool.parent,t=e.getScript("qc.TweenPosition"),n=this._step.gameObject,r=new qc.Point(-n.x-e.parent.width*.5,-n.y);t.to=r.clone(),t.setCurrToStartValue(),t.resetToBeginning(),t.play(),r.subtract(t.from.x,t.from.y),qc.Koala.onTweenCamera.dispatch(r)},L.prototype.adjustCamera=function(e,t){var n=this.pillarPool.parent,r=this._step.gameObject;n.x-=e,n.y-t<-r.y?n.y=-r.y:n.y-=t,qc.Koala.onAdjustCamera.dispatch(new qc.Point(e,t))},L.prototype.resetCamera=function(){var e=this.pillarPool.parent,t=e.getScript("qc.TweenPosition");t.to=new qc.Point(-e.parent.width*.5,0),t.setCurrToStartValue(),t.resetToBeginning(),t.play()},L.prototype.gameOver=function(e){qc.Koala.logic.me.isDie=!0,this.pauseBtn.interactive=!1;if(e===-1){qc.Koala.onGameOver.dispatch();return}if(e===-2){var t=this.koala.getScript("qc.Koala.ui.Koala");t.die(function(){qc.Koala.onGameOver.dispatch()})}},L.prototype.show=function(){this.gameObject.visible=!0},L.prototype.hide=function(){this.gameObject.visible=!1};var A=qc.defineBehaviour("qc.Koala.ui.Pause",qc.Behaviour,function(){},{continueBtn:qc.Serializer.NODE,restartBtn:qc.Serializer.NODE,shareBtn:qc.Serializer.NODE,moreBtn:qc.Serializer.NODE,rankBtn:qc.Serializer.NODE});A.prototype.awake=function(){var e=this;this.addListener(qc.Koala.onPause,this.show,this),this.addListener(this.continueBtn.onClick,this.onContinueBtnClick,this),this.addListener(this.restartBtn.onClick,this.onRestartBtnClick,this),this.addListener(this.shareBtn.onClick,function(){qc.Koala.showShareMsg.dispatch()},this),this.addListener(this.moreBtn.onClick,function(){document.location.href=qc.Koala.logic.config.followHref},this),this.addListener(this.rankBtn.onClick,this.onRankBtnClick,this)},A.prototype.onRestartBtnClick=function(){qc.Koala.onStart.dispatch(!0),this.hide()},A.prototype.onContinueBtnClick=function(){qc.Koala.logic.me.paused=!1,qc.Koala.onContinue.dispatch(),this.hide()},A.prototype.onRankBtnClick=function(){qc.Koala.logic.me.userInfo&&qc.Koala.logic.me.userInfo.subscribe?(qc.Koala.onRankingClose.addOnce(this.show,this),qc.Koala.showRanking.dispatch(),this.hide()):qc.Koala.showFollowMsg.dispatch()},A.prototype.show=function(){this.gameObject.visible=!0},A.prototype.hide=function(){this.gameObject.visible=!1};var m=qc.defineBehaviour("qc.Koala.ui.Pillar",qc.Behaviour,function(){this.swing=null,this.scoreRect=Infinity},{swingPrefab:qc.Serializer.PREFAB,bg:qc.Serializer.NODE,head:qc.Serializer.NODE});m.prototype.init=function(e,t){var n=qc.Koala.logic.pillar.getInfo(t);this.gameObject.width=n.thickness,this.scoreRect=n.scoreRect,this.initBg(n.thickness),this.initHead(n.headIcon),this.gameObject.y=n.top-this.gameObject.parent.y,e==null?this.gameObject.x=0:(this.gameObject.x=e.gameObject.x+qc.Koala.GAMEWIDTH-this.gameObject.width,this.gameObject.y+=e.gameObject.y),console.log("this.gameObject.y:",this.gameObject.y),this.swing||(this.swing=this.createSwing()),this.initSwing()},m.prototype.initBg=function(e){var t=this.bg.nativeSize.width,n=e/t,r=this.bg.parent.height*(1-n),i=t*(1-n);this.bg.scaleX=this.bg.scaleY=n,this.bg.bottom=-r,this.bg.right=-i},m.prototype.initHead=function(e){this.head.frame=e+".png"},m.prototype.createSwing=function(){var e=this.game.add.clone(this.swingPrefab,this.gameObject.parent.parent);return e.getScript("qc.Koala.ui.Swing")},m.prototype.initSwing=function(){this.swing.init(this)};var O=qc.defineBehaviour("qc.Koala.ui.PillarPool",qc.Behaviour,function(){this.pillarList=[]},{pillarPrefab:qc.Serializer.PREFAB});O.prototype.awake=function(){this.addListener(qc.Koala.onLogicReady,this._init,this)},O.prototype._init=function(){this.gameObject.top=qc.Koala.logic.config.pillarTopMin;var e=null;for(var t=0;t<3;t++){var n=this.pillarList[t]||this.createPillar();e?n.init(e,t):n.init(null,t),e=n,this.pillarList[t]=n}qc.Koala.onPillarReady.dispatch(this.pillarList)},O.prototype.createPillar=function(){var e=this.game.add.clone(this.pillarPrefab,this.gameObject);return e.getScript("qc.Koala.ui.Pillar")},O.prototype.next=function(){var e=this.pillarList.shift();this.pillarList.push(e);var t=this.getStep();e.init(t,qc.Koala.logic.me.level+1)},O.prototype.reset=function(){this._init()},O.prototype.getStep=function(){return this.pillarList[1]};var M=qc.defineBehaviour("qc.Koala.ui.RankData",com.qici.extraUI.TableViewAdapter,function(){this.rankData=null},{});M.prototype.awake=function(){},M.prototype.update=function(){},M.prototype.revokeCell=function(e,t,n){},M.prototype.createCell=function(e,t,n){if(this.rankData&&this.rankData[n]){var r=e.getScript("qc.Koala.ui.RankingRow");r.init(this.rankData[n])}},M.prototype.getTableSize=function(){return{x:1,y:this.rankData?this.rankData.length:0}},M.prototype.findCellWithPos=function(e,t){return{x:Math.floor(e/510),y:Math.floor(t/141)}},M.prototype.getCellRect=function(e,t){return new qc.Rectangle(e*510,t*141+this.gameObject.getScript("com.qici.extraUI.TableView").extraTop,510,141)};var _=qc.defineBehaviour("qc.Koala.ui.Ranking",qc.Behaviour,function(){this._rankingData=[],this._iconKeyList=[]},{rankingList:qc.Serializer.NODE,rankingRowPrefab:qc.Serializer.PREFAB,ownRanking:qc.Serializer.NODE,waiting:qc.Serializer.NODE,closeBtn:qc.Serializer.NODE});_.prototype.awake=function(){this.addListener(qc.Koala.showRanking,this.show,this),this.addListener(this.closeBtn.onClick,this.close,this)},_.prototype.getRanking=function(){var e=this,t=qc.Koala.logic.me;qc.Interactive.getRank(t.rid,t.token,t.channel,function(n){n=JSON.parse(n);var r=0,i=n.rankTop;for(var s=0;s<i.length;s++){var o=i[s];o.rid===t.rid&&(r=s+1),o.ranking=s+1}n.selfRank=n.userData[0],n.selfRank&&(n.selfRank.ranking=r),e.getRankingSuccess(n)})},_.prototype.getRankingSuccess=function(e){this.waiting.stop(),this.waiting.visible=!1;var t=this.rankingList.getScript("qc.Koala.ui.RankData");t.rankData=e.rankTop,t.dispatchDataChange(),this.initOwnRanking(e.selfRank)},_.prototype.initOwnRanking=function(e){var t=this.ownRanking.getScript("qc.Koala.ui.RankingRow");t.init(e),this.ownRanking.visible=!0},_.prototype.show=function(){this.gameObject.visible=!0,this.waiting.visible=!0,this.waiting.playAnimation("zhuan",null,!0),this.getRanking()},_.prototype.close=function(){this.gameObject.visible=!1,this._rankingData.length=0,this._iconKeyList.forEach(function(e){this.game.assets.unload(e)},this),this._iconKeyList.length=0,qc.Koala.onRankingClose.dispatch()};var D=qc.defineBehaviour("qc.Koala.ui.RankingRow",qc.Behaviour,function(){},{rankingLabel:qc.Serializer.NODE,headIcon:qc.Serializer.NODE,nameLabel:qc.Serializer.NODE,score:qc.Serializer.NODE});D.COLORMAP={1:{color:new qc.Color("#F9FB02"),stroke:new qc.Color("#860001")},2:{color:new qc.Color("#C5C6C1"),stroke:new qc.Color("#3A3436")},3:{color:new qc.Color("#FEB266"),stroke:new qc.Color("#591B02")}},D.DEFAULTCOLOR={color:new qc.Color("#FFFFFF"),stroke:new qc.Color("#A00F0A")},D.prototype.init=function(e){this.nameLabel.text=e.name,this.score.text=e.scorers+"";var t=e.headurl,n=this.headIcon;t&&this.game.assets.loadTexture(e.rid,t,function(e){n.texture=e});var r=e.ranking||"100+",i=r+"",s=D.DEFAULTCOLOR;r<=3?(i="NO."+r,s=D.COLORMAP[r]):this.rankingLabel.fontSize=52,this.rankingLabel.color=s.color,this.rankingLabel.stroke=s.stroke,this.rankingLabel.strokeThickness=3,this.rankingLabel.text=i};var P=qc.defineBehaviour("qc.Koala.ui.ShareMsg",qc.Behaviour,function(){},{arrow:qc.Serializer.NODE,msgLabel:qc.Serializer.NODE});P.prototype.awake=function(){this.addListener(qc.Koala.showShareMsg,this.show,this)},P.prototype.init=function(){this.arrow.visible=qc.qcWeChat.isWeChat(),this.arrow.visible?this.msgLabel.text="点击右上角\n分享给您的好友们吧\n看看他们能取得多少分":this.msgLabel.text="请使用分享功能\n告诉给您的好友们吧\n看看他们能取得多少分"},P.prototype.onClick=function(){this.hide()},P.prototype.hide=function(){this.gameObject.visible=!1},P.prototype.show=function(){this.init(),this.gameObject.visible=!0};var H=qc.defineBehaviour("qc.Koala.ui.Swing",qc.Behaviour,function(){this._maxRotation=0,this.direction=1,this.deltaRotation=Math.PI/180*5,this.beginRotation=0},{});t.defineProperties(H.prototype,{maxRotation:{get:function(){return this._maxRotation},set:function(e){if(this._maxRotation===e)return;this._maxRotation=e;var t=this.gameObject.getScript("qc.TweenRotation");t.from=e,t.to=-e}}}),H.prototype.awake=function(){var e=this.gameObject.getScript("qc.TweenRotation");this.addListener(e.onLoopFinished,this._onSwingFinished,this)},H.prototype._onSwingFinished=function(){this.direction*=-1},H.prototype.init=function(e){this.gameObject.anchoredX=e.gameObject.x,this.gameObject.y=e.gameObject.y,console.log("pillar.gameObject.x:",e.gameObject.x),console.log("pillar.gameObject.y:",e.gameObject.y);var t=e.gameObject.parent.y,n=qc.Koala.GAMEWIDTH*.5-e.gameObject.width;this.beginRotation=Math.atan(n/t),this.maxRotation=this.beginRotation+this.deltaRotation,this.gameObject.height=Math.sqrt(n*n+t*t),this.reset()},H.prototype.play=function(e){e||qc.Tween.resetGroupToBeginning(this.gameObject,2),qc.Tween.playGroup(this.gameObject,2)},H.prototype.stop=function(){qc.Tween.stopGroup(this.gameObject,2)},H.prototype.reset=function(){qc.Tween.stopGroup(this.gameObject,2),qc.Tween.resetGroupToBeginning(this.gameObject,2),this.gameObject.rotation=this.beginRotation,this.direction=1};var B=qc.defineBehaviour("qc.Koala.ui.Welcome",qc.Behaviour,function(){},{quickBtn:qc.Serializer.NODE,wechatBtn:qc.Serializer.NODE,config:qc.Serializer.EXCELASSET,loginMask:qc.Serializer.NODE});B.prototype.awake=function(){qc.Koala.initLogic(this.config,this.game),this.addListener(this.quickBtn.onClick,this._onStart,this),this.addListener(this.wechatBtn.onClick,this._wechatLogin,this),this.addListener(qc.Koala.onLogining,this._logining,this),this.addListener(qc.Koala.onLoginFail,this._loginFail,this),this.addListener(qc.Koala.onLogin,this.hide,this);var e=this.getScript("qc.QcWeChat");this.quickBtn.visible=!e.isWeChat(),this.quickBtn.parent.getScript("qc.TableLayout").rebuildTable(),this.addListener(e.onStartLogin,function(){qc.Koala.onLogining.dispatch()},this),this.addListener(e.onLogin,function(e){e==="success"?this._loginSuccess():qc.Koala.onLoginFail.dispatch()},this),this.addListener(e.onShare,function(e){e.title=qc.Koala.logic.share.getContent(qc.Koala.logic.me.score),e.imgUrl=qc.Koala.logic.config.shareIcon,e.desc=""},this)},B.prototype._onStart=function(){qc.Koala.onStart.dispatch(),this.hide()},B.prototype._wechatLogin=function(){this.getScript("qc.QcWeChat").login()},B.prototype._loginSuccess=function(){var e=this.getScript("qc.QcWeChat");e.user&&(qc.Koala.logic.me.token=e.user.token,qc.Koala.logic.me.rid=e.user.rid,qc.Koala.logic.me.userInfo=e.user),qc.Koala.logic.me.channel="weixin",this._onStart(),qc.Koala.logic.me.adjustBest()},B.prototype._logining=function(){this.loginMask.visible=!0},B.prototype._loginFail=function(){this.loginMask.visible=!1},B.prototype.hide=function(){this.gameObject.visible=!1},B.prototype.show=function(){this.gameObject.visible=!0}}).call(this,this,Object)